# Base docker-compose configuration for wireframe-mcp
# Extend with docker-compose.dev.yml or docker-compose.prod.yml
#
# Port Configuration (override via environment):
#   MCP_PORT     - MCP server port (default: 18080)
#   KROKI_PORT   - Kroki renderer port (default: 18000)
#
# Usage:
#   Development: docker compose -f docker/docker-compose.yml -f docker/docker-compose.dev.yml up
#   Production:  docker compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml up
#   Custom port: MCP_PORT=9080 KROKI_PORT=9000 docker compose up

services:
  # -------------------------------------------------------------------------
  # Main wireframe-mcp service
  # -------------------------------------------------------------------------
  wireframe-mcp:
    image: wireframe-mcp:latest
    container_name: wireframe-mcp
    hostname: wireframe-mcp
    networks:
      - wireframe-net
    ports:
      - "${MCP_PORT:-18080}:18080"
    volumes:
      # Named volumes for persistent data
      - wireframe-corpus-data:/app/corpus/data:rw
      - wireframe-corpus-models:/app/corpus/models:rw
      - wireframe-output:/app/data:rw
    env_file:
      # Secrets stored in main branch (worktree structure: ../main/.env)
      # Falls back to local .env if running from main branch directly
      - ../../main/.env
    environment:
      # Server configuration
      - MCP_HOST=0.0.0.0
      - MCP_PORT=18080
      # Corpus paths (container paths)
      - CORPUS_PATH=/app/corpus
      - CORPUS_DATA_DIR=/app/corpus/data
      - CORPUS_MODELS_DIR=/app/corpus/models
      # Kroki renderer URL (internal network hostname)
      - KROKI_URL=http://kroki:18000
      # Logging
      - LOG_LEVEL=INFO
      # GPU support
      - VECTOR_USE_GPU=true
    depends_on:
      kroki:
        condition: service_healthy
    restart: unless-stopped

  # -------------------------------------------------------------------------
  # Kroki diagram rendering service
  # Converts D2/PlantUML to PNG/SVG
  # Port 18000 chosen to avoid conflicts with common services:
  #   - 8000: Django, FastAPI, Python HTTP servers
  #   - 8080: Tomcat, Spring Boot, Jenkins
  # -------------------------------------------------------------------------
  kroki:
    image: yuzutech/kroki
    container_name: kroki
    hostname: kroki
    networks:
      - wireframe-net
    ports:
      - "${KROKI_PORT:-18000}:8000"
    environment:
      - KROKI_SAFE_MODE=unsafe
      - KROKI_MAX_URI_LENGTH=8192
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8000/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

# ---------------------------------------------------------------------------
# Networks
# ---------------------------------------------------------------------------
networks:
  wireframe-net:
    name: wireframe-net
    driver: bridge

# ---------------------------------------------------------------------------
# Named Volumes for persistent data
# ---------------------------------------------------------------------------
volumes:
  # Corpus dataset storage (RICO, ENRICO, WebSight, etc.)
  wireframe-corpus-data:
    name: wireframe-corpus-data

  # Embedding models (sentence-transformers, etc.)
  wireframe-corpus-models:
    name: wireframe-corpus-models

  # Output data (generated layouts, indices, benchmarks)
  wireframe-output:
    name: wireframe-output
